<!DOCTYPE html>
{% autoescape true %}
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
  <title>Lychee</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Free medicine delivery anytime, anywhere">

  <!-- Font Awesome -->
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- Google Font -->
  <link href='http://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
  <!-- Bootstrap -->
  <link href="./css/bootstrap.min.css" rel="stylesheet" media="screen">
  <link href="./css/style.css" rel="stylesheet" media="screen">
  <link href="./css/style_button.css" rel="stylesheet">
  <link rel='stylesheet' href='./calendar/fullcalendar.css' />
  <script src='./javascript/jquery.min.js'></script>
  <script src='./javascript/moment.min.js'></script>
  <script src='./calendar/fullcalendar.js'></script>
  <script src="./javascript/typed.js"></script>
  <script src="./javascript/bootstrap.min.js"></script>
  <script src="./javascript/typed.js"></script>
  <script>

    event_id_counter = 0
    selected_players = []
    function clickOnSomebody(checkbox) {
      selected_players.push(checkbox.value);
    }

    function createANiceButton(text) {
      var str = '<div id="ck-button">\
                  <label>\
                    <input type="checkbox" value="'+text+'" onchange="clickOnSomebody(this)"><span>'+text+'</span>\
                  </label>\
                </div>';
      return str
    }

    // query db to find this
    function getListOfRecent() {
      var recent = ["abhi", "sergey", "andrew"];
      document.getElementById("recent").innerHTML = "";
      for (var i=0; i<recent.length; i++) {
        if (recent[i] != player_name) {
          var btn = createANiceButton(recent[i])
          document.getElementById("recent").innerHTML += btn;
        }
      }
    }

    function all_players() {
      var all = ["andrew", "sergey", "abhi", "ruofeng", "shengwei", "shubo", "allen", "qi"];
      document.getElementById("all_players").innerHTML = "";
      for (var i=0; i<all.length; i++) {
        if (all[i] != player_name) {
          var btn = createANiceButton(all[i])
          document.getElementById("all_players").innerHTML += btn;
        }
      }
    }

    function send_request(url) {
      var request = new XMLHttpRequest();
      request.open("GET", url, false);
      request.send(null);
      var returnValue = request.responseText;
      return returnValue;
    }

    function overlap(new_event, old_event) {
      if (old_event.start > new_event.start && old_event.end < new_event.start)
        return false;
      if (old_event.start > new_event.end && old_event.end < new_event.end)
        return false;
      return true;
    }

    $(document).ready(function() {

      // page is now ready, initialize the calendar...

      $('#calendar').fullCalendar({
        // put your options and callbacks here

        selectable: true,
        selectHelper: true,
        select: function(start, end) {

          var json_str = send_request('/get_reservations');
          events = JSON.parse(json_str);
          var no_overlap = true;

          title = player_name;
          if (title) {
            if (event_id_counter == 0) {
              eventData = {
                id: event_id_counter,
                title: title,
                start: start,
                end: end
              };

              // make sure there's not collision with existing reservations

              

              for (var i=0; i<events.length; i++) {
                if(overlap(eventData, events[i])) {
                  no_overlap = false;
                  break;
                }
              }

              if (no_overlap) {
                $('#calendar').fullCalendar('renderEvent', eventData, true);
              }
            }

            if (event_id_counter > 0) {
              $('#calendar').fullCalendar('removeEvents', event_id_counter);
              event_id_counter = 0;
            }
            event_id_counter++;
          }
          $('#calendar').fullCalendar('unselect');

          console.log(no_overlap);
          if (no_overlap) {
            getListOfRecent();
            all_players();
          }
        }
      })
    });

    function showEventsOnCalendar() {

      var json_str = send_request('/get_reservations');
      events = JSON.parse(json_str);
      for (var i=0; i<events.length; i++) {
        var title = "";
        for (var j=0; j<events[i].players.length; j++) {
          title = title.concat(events[i].players[j]);
          title = title.concat(", ")
        }
        title = title.substring(0, title.length-2);
        eventData = {
          title: title,
          start: events[i].start,
          end: events[i].end
        };
        console.log(eventData);
        $('#calendar').fullCalendar('renderEvent', eventData, true);
      }
      // document.getElementById("player").innerHTML = events[0];
    }

    function cancel() {
      $('#calendar').fullCalendar('removeEvents', 0);
      event_id_counter = 0;
    }

    function done() {
      // add something to title
      var title = "";
      title = title.concat(player_name);
      title = title.concat(", ")
      for (var j=0; j<selected_players.length; j++) {
        title = title.concat(selected_players[j]);
        title = title.concat(", ")
      }
      title = title.substring(0, title.length-2);
      eventData.title = title;
      $('#calendar').fullCalendar('removeEvents', 0);
      $('#calendar').fullCalendar('renderEvent', eventData, true);

      // put to db and refresh
    }

    function search() {
      var name = document.getElementById("search").value;
      console.log(name);
      return name;
    }

    function CreateNewUser() {
      player_name = document.getElementById("input_name").value;
      email = document.getElementById("input_email").value;
      send_request('/create_player?name='+player_name+'&email='+email);
      setCookie();
    }

    function checkIfThisUserIsInDB() {
      var json_str = send_request('/get_public');
      var players = JSON.parse(json_str);
      var found = false;
      for (var i=0; i<players.length; i++) {
        if (players[i].name == document.getElementById("input_name").value) {
          found = true;
          setCookie();
          break;
        }
      }
      if (found == false) {
        // create a textbox for email
        document.getElementById("create_new_user").innerHTML = 'Yah, new player ~ ^_^ ~ What is your email, man?<input id="input_email" type="text" name="Email"></input>\
          <input type="submit" onclick="CreateNewUser()"></input>';
      }
    }

    function setCookie() {
        document.cookie = document.getElementById("input_name").value + "; expires=Thu, 1 Jan 2099 00:00:00 UTC";
        checkCookie();
    }
    function getCookie() {
        return document.cookie;
    }
    function removeCookie() {
        document.cookie = "; expires=Thu, 1 Jan 1970 00:00:00 UTC";
        checkCookie();
    }
    function checkCookie() {
        player_name = getCookie();
        if (player_name != "") {
            showPlayerName(player_name);
            document.getElementById('loginbox').setAttribute('style', 'display: none');
            document.getElementById('logoutbutton').setAttribute('style', 'display: yes');
        } else {
            document.getElementById("player_name").innerHTML = "none";
            document.getElementById('loginbox').setAttribute('style', 'display: yes');
            document.getElementById('logoutbutton').setAttribute('style', 'display: none');
        }
    }
    function showPlayerName(pname) {
        var player = pname;
        document.getElementById("player_name").innerHTML = player;
    }

    function load() {
        showEventsOnCalendar();
        checkCookie();
    }

  </script>
  <style>

  body {
    margin: 0;
    padding: 0;
    font-family: "Lucida Grande",Helvetica,Arial,Verdana,sans-serif;
    font-size: 14px;
  }

  #calendar {
    width: 500px;
    margin: 40px auto;
  }

  </style>

</head>
<body onload="load()">
  <nav class="navbar navbar-black navbar-fixed-top" role="navigation">
    <div class="container content">
      <div class="pull-left">
        <div id="loginbox">
          <span> Player: </span>
          <input id="input_name" type="text" onkeydown="if (event.keyCode == 13) document.getElementById('submitbutton').click()"></input>
          <input id="submitbutton" type="submit" onclick="checkIfThisUserIsInDB()"></input>
        </div>
        <div id="create_new_user"></div>
        <span>   You are: </span>
        <span id="player_name">none</span>
        <input id="logoutbutton" style="display: none" type="submit" onclick="removeCookie()" value="logout"></input>
      </div>
      <div class="pull-right">
        <span> Ping-pong table status:</span>
        <span id="table-status">FREE</span>
      </div>
    </div>
  </nav>
  <div class="container section">    
    <div class="row">
      <div class="col-lg-6">
        <div id='calendar'></div>
      </div>
      <div class="col-lg-6">
        <div class="status-div">
          <div id="info">
            You played with:
            <div id="recent"></div>
            <input type="text" id="search">
            <button onclick="search()">search</button>
            Everyone:
            <div id="all_players"></div>
            <button onclick="cancel()">Cancel</button>
            <button onclick="done()">DONE!</button>
          </div>
        </div>
      </div>
    </div>
</div>
  </body>
</html>
{% endautoescape %}
