<!DOCTYPE html>
{% autoescape true %}
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
  <title>Lychee</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Free medicine delivery anytime, anywhere">

  <!-- Font Awesome -->
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- Google Font -->
  <link href='http://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
  <!-- Bootstrap -->
  <link href="./css/bootstrap.min.css" rel="stylesheet" media="screen">
  <link href="./css/style.css" rel="stylesheet" media="screen">
  <link href="./css/style_button.css" rel="stylesheet">
  <link rel='stylesheet' href='./calendar/fullcalendar.css' />
  <script src='./javascript/jquery.min.js'></script>
  <script src='./javascript/moment.min.js'></script>
  <script src='./calendar/fullcalendar.js'></script>
  <script src="./javascript/typed.js"></script>
  <script src="./javascript/bootstrap.min.js"></script>
  <script src="./javascript/typed.js"></script>
  <script>

    selected_players = []
    function clickOnSomebody(checkbox) {
      selected_players.push(checkbox.value);
    }

    function createANiceButton(text) {
      var str = '<div id="ck-button">\
                  <label>\
                    <input type="checkbox" value="'+text+'" onchange="clickOnSomebody(this)"><span>'+text+'</span>\
                  </label>\
                </div>';
      return str
    }

    // query db to find this
    function getListOfRecent() {
      var recent = ["Abhi", "Sergey", "Andrew"];
      document.getElementById("recent").innerHTML = "";
      for (var i=0; i<recent.length; i++) {
        var btn = createANiceButton(recent[i])
        document.getElementById("recent").innerHTML += btn;
      }
    }

    function all_players() {
      var all = ["Andrew", "Sergey", "Abhi", "Ruofeng", "Shengwei", "Shubo", "Allen", "Qi"];
      document.getElementById("all_players").innerHTML = "";
      for (var i=0; i<all.length; i++) {
        var btn = createANiceButton(all[i])
        document.getElementById("all_players").innerHTML += btn;
      }
    }

    function send_request(url) {
      var request = new XMLHttpRequest();
      request.open("GET", url, false);
      request.send(null);
      var returnValue = request.responseText;
      return returnValue;
    }

    $(document).ready(function() {

      // page is now ready, initialize the calendar...

      $('#calendar').fullCalendar({
        // put your options and callbacks here
        selectable: true,
        selectHelper: true,
        select: function(start, end) {
          title = player_name;
          if (title) {
            eventData = {
              id: 5123252,
              title: title,
              start: start,
              end: end
            };
            $('#calendar').fullCalendar('renderEvent', eventData, true);
          }
          $('#calendar').fullCalendar('unselect');
          getListOfRecent();
          all_players();
        }
      })
    });

    function showEventsOnCalendar() {
      var json_str = '\
      [\
        {\
            "players":["Abhi", "Shengwei", "Ruofeng", "Allen", "Tony"],\
            "start":"Thu Aug 15 2014 09:15:00 GMT+0000",\
            "end":"Thu Aug 15 2014 10:10:00 GMT+0000"\
        },\
        {\
            "players":["Abhi", "Allen", "Tony"],\
            "start":"Thu Aug 15 2014 13:45:00 GMT+0000",\
            "end":"Thu Aug 15 2014 14:10:00 GMT+0000"\
        }\
      ]\
      '
      var events = JSON.parse(json_str);
      console.log(events.length);
      for (var i=0; i<events.length; i++) {
        var title = "";
        for (var j=0; j<events[i].players.length; j++) {
          title = title.concat(events[i].players[j]);
          title = title.concat(", ")
        }
        title = title.substring(0, title.length-2);
        eventData = {
          title: title,
          start: events[i].start,
          end: events[i].end
        };
        $('#calendar').fullCalendar('renderEvent', eventData, true);
      }
      // document.getElementById("player").innerHTML = events[0];
    }

    function cancel() {
      $('#calendar').fullCalendar('removeEvents', eventData.id);
    }

    function done() {
      // add something to title
      var title = "";
      for (var j=0; j<selected_players.length; j++) {
        title = title.concat(selected_players[j]);
        title = title.concat(", ")
      }
      title = title.substring(0, title.length-2);
      eventData.title = title;
      $('#calendar').fullCalendar('removeEvents', eventData.id);
      $('#calendar').fullCalendar('renderEvent', eventData, true);
      
    }

    function search() {
      var name = document.getElementById("search").value;
      console.log(name);
      return name;
    }

    function CreateNewUser() {
      player_name = document.getElementById("input_name").value;
      email = document.getElementById("input_email").value;
      send_request('/create_player?name='+player_name+'&email='+email);
      setCookie();
    }

    function checkIfThisUserIsInDB() {
      var json_str = send_request('/get_public');
      var players = JSON.parse(json_str);
      var found = false;
      for (var i=0; i<players.length; i++) {
        if (players[i].name == document.getElementById("input_name").value) {
          found = true;
          setCookie();
          break;
        }
      }
      if (found == false) {
        // create a textbox for email
        document.getElementById("create_new_user").innerHTML = 'Yah, new player ~ ^_^ ~ What is your email, man?<input id="input_email" type="text" name="Email"></input>\
          <input type="submit" onclick="CreateNewUser()"></input>';
      }
    }

    function setCookie() {
        document.cookie = document.getElementById("input_name").value;
        checkCookie();
    }
    function getCookie() {
        return document.cookie;
    }
    function checkCookie() {
        player_name = getCookie();
        if (player_name != "") {
            showPlayerName(player_name);
        } else {
            showLogin();
        }
    }
    function showPlayerName(pname) {
        var player = pname;
        document.getElementById("player_name").innerHTML = player;
    }
    function showLogin() {
    }

    function load() {
        showEventsOnCalendar();
        checkCookie();
    }

  </script>
  <style>

  body {
    margin: 0;
    padding: 0;
    font-family: "Lucida Grande",Helvetica,Arial,Verdana,sans-serif;
    font-size: 14px;
  }

  #calendar {
    width: 500px;
    margin: 40px auto;
  }

  </style>

</head>
<body onload="load()">
  <div class="container">
    <div class="row">
      <span> Player: </span>
      <input id="input_name" type="text" name="Name"></input>
      <input type="submit" onclick="checkIfThisUserIsInDB()"></input>
      <div id="create_new_user"></div>
      <span>   You are: </span>
      <span id="player_name">none</span>
    </div>
    <div class="row">
      <span> Ping-pong table status:</span>
      <span id="table-status">FREE</span>
    </div>
    <div class="row">
      <div class="col-lg-6">
        <div id='calendar'></div>
      </div>
      <div class="col-lg-6">
        <div class="status-div">
          <div id="info">
            You played with:
            <div id="recent"></div>
            <input type="text" id="search">
            <button onclick="search()">search</button>
            Everyone:
            <div id="all_players"></div>
            <button onclick="cancel()">Cancel</button>
            <button onclick="done()">DONE!</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  </body>
</html>
{% endautoescape %}
